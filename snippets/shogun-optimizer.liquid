{% comment %}
Auto-generated by Shogun-AB.
This file can be re-written at any time.
{% endcomment %}


{% if article %}
  {% assign content = article %}
{% elsif blog %}
  {% assign content = blog %}
{% elsif page %}
  {% assign content = page %}
{% elsif product %}
  {% assign content = product %}
{% elsif collection %}
  {% assign content = collection %}
{% elsif metaobject %}
  {% assign content = metaobject.system %}
{% endif %}

<script src="/cdn/shopifycloud/consent-tracking-api/v0.1/consent-tracking-api.js"></script>

<script type="text/javascript">
  var H=Object.defineProperty;var J=(m,g,p)=>g in m?H(m,g,{enumerable:!0,configurable:!0,writable:!0,value:p}):m[g]=p;var n=(m,g,p)=>J(m,typeof g!="symbol"?g+"":g,p);(function(){"use strict";var m=" daum[ /]| deusu/| yadirectfetcher|(?:^|[^g])news(?!sapphire)|(?<! (?:channel/|google/))google(?!(app|/google| pixel))|(?<! cu)bots?(?:\\b|_)|(?<!(?:lib))http|(?<![hg]m)score|(?<!cam)scan|@[a-z][\\w-]+\\.|\\(\\)|\\.com\\b|\\btime/|\\||^<|^[\\w \\.\\-\\(?:\\):%]+(?:/v?\\d+(?:\\.\\d+)?(?:\\.\\d{1,10})*?)?(?:,|$)|^[^ ]{50,}$|^\\d+\\b|^\\w*search\\b|^\\w+/[\\w\\(\\)]*$|^active|^ad muncher|^amaya|^avsdevicesdk/|^biglotron|^bot|^bw/|^clamav[ /]|^client/|^cobweb/|^custom|^ddg[_-]android|^discourse|^dispatch/\\d|^downcast/|^duckduckgo|^email|^facebook|^getright/|^gozilla/|^hobbit|^hotzonu|^hwcdn/|^igetter/|^jeode/|^jetty/|^jigsaw|^microsoft bits|^movabletype|^mozilla/\\d\\.\\d\\s[\\w\\.-]+$|^mozilla/\\d\\.\\d\\s\\(compatible;?(?:\\s\\w+\\/\\d+\\.\\d+)?\\)$|^navermailapp|^netsurf|^offline|^openai/|^owler|^php|^postman|^python|^rank|^read|^reed|^rest|^rss|^snapchat|^space bison|^svn|^swcd |^taringa|^thumbor/|^track|^w3c|^webbandit/|^webcopier|^wget|^whatsapp|^wordpress|^xenu link sleuth|^yahoo|^yandex|^zdm/\\d|^zoom marketplace/|^{{.*}}$|analyzer|archive|ask jeeves/teoma|audit|bit\\.ly/|bluecoat drtr|browsex|burpcollaborator|capture|catch|check\\b|checker|chrome-lighthouse|chromeframe|classifier|cloudflare|convertify|crawl|cypress/|dareboost|datanyze|dejaclick|detect|dmbrowser|download|evc-batch/|exaleadcloudview|feed|firephp|functionize|gomezagent|grab|headless|httrack|hubspot marketing grader|hydra|ibisbrowser|infrawatch|insight|inspect|iplabel|ips-agent|java(?!;)|library|linkcheck|mail\\.ru/|manager|measure|neustar wpm|node|nutch|offbyone|onetrust|optimize|pageburst|pagespeed|parser|perl|phantomjs|pingdom|powermarks|preview|proxy|ptst[ /]\\d|retriever|rexx;|rigor|rss\\b|scrape|server|sogou|sparkler/|speedcurve|spider|splash|statuscake|supercleaner|synapse|synthetic|tools|torrent|transcoder|url|validator|virtuoso|wappalyzer|webglance|webkit2png|whatcms/|xtate/",g=/bot|crawl|http|lighthouse|scan|search|spider/i,p;function R(){if(p instanceof RegExp)return p;try{p=new RegExp(m,"i")}catch{p=g}return p}function z(c){return!!c&&R().test(c)}/*! js-cookie v3.0.5 | MIT */function _(c){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)c[i]=t[i]}return c}var M={read:function(c){return c[0]==='"'&&(c=c.slice(1,-1)),c.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(c){return encodeURIComponent(c).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function P(c,e){function t(r,a,s){if(!(typeof document>"u")){s=_({},e,s),typeof s.expires=="number"&&(s.expires=new Date(Date.now()+s.expires*864e5)),s.expires&&(s.expires=s.expires.toUTCString()),r=encodeURIComponent(r).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var o="";for(var h in s)s[h]&&(o+="; "+h,s[h]!==!0&&(o+="="+s[h].split(";")[0]));return document.cookie=r+"="+c.write(a,r)+o}}function i(r){if(!(typeof document>"u"||arguments.length&&!r)){for(var a=document.cookie?document.cookie.split("; "):[],s={},o=0;o<a.length;o++){var h=a[o].split("="),d=h.slice(1).join("=");try{var f=decodeURIComponent(h[0]);if(s[f]=c.read(d,f),r===f)break}catch{}}return r?s[r]:s}}return Object.create({set:t,get:i,remove:function(r,a){t(r,"",_({},a,{expires:-1}))},withAttributes:function(r){return P(this.converter,_({},this.attributes,r))},withConverter:function(r){return P(_({},this.converter,r),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(c)}})}var V=P(M,{path:"/"});const O=c=>{const e=window.innerWidth<768||window.outerWidth<768?"mobile":"desktop";return c===e},C=(c,e)=>{const t=!!e,i=String(c)==="true";return t===i},I="shg_geo_data";function U(c,e){const t=c-e;return Math.floor(t/(1e3*60*60*24))}function F(){if(new URLSearchParams(window.location.search).get("shg_geo_cache")==="false")return null;let e=null;try{const t=localStorage.getItem(I);if(t){const i=JSON.parse(t),r=Date.now();i.timestamp&&U(r,i.timestamp)<=7?e=i:localStorage.removeItem(I)}}catch(t){return console.error("Error reading geo data from cache:",t),localStorage.removeItem(I),null}return e}function L(c){let e=null;if(!c)return console.warn("Geo location API URL not configured."),e;try{const t=new XMLHttpRequest;t.open("GET",c,!1),t.send(null),t.status===200?(e=JSON.parse(t.responseText),e?(e.timestamp=Date.now(),localStorage.setItem(I,JSON.stringify(e))):(console.error("Geo API response parsed to null or undefined."),e=null)):console.error(`Geo API request failed with status: ${t.status}`)}catch(t){console.error("Error fetching geo data from API:",t)}return e}function B(c){let e=null;try{const t=F();t?(e=t,console.debug("Loaded geo data from cache:",e)):(e=L(c),console.debug("Fetched geo data from API:",e))}catch(t){console.error("Error initializing geo data:",t),e=null}return e}const N=(c,e)=>{const{type:t,country_code:i,toponym_name:r,parent_name:a}=c||{},{country:s,region:o,city:h}=e||{};if(!t||!i||!e)return!1;switch(t){case"country":return s===i;case"region":return o===r&&s===i;case"city":return h===r&&o===a&&s===i;default:return console.debug("Unknown location type:",t),!1}},Q=c=>typeof c!="string"?!1:document.referrer.toLowerCase().includes(c.toLowerCase()),j=c=>typeof c!="string"?!1:window.location.href.toLowerCase().includes(c.toLowerCase()),q=(c,e,t)=>{if(!e)return!1;const{expectedTimeInMillseconds:i,withinOrAfter:r}=c||{};if(typeof i!="number"||!r)return!1;const a=e.first_visit_timestamp;return r==="within"?a+i>t:a+i<t},x=(c,e,t)=>e?t-e.first_visit_timestamp<18e5===c:c===!0;function G(c,e){return c===e}const y=class y{constructor(e){n(this,"visitorDetails",null);n(this,"currentTime");n(this,"geoLocationApi");n(this,"customerId");n(this,"isB2B");n(this,"internalGeoData");n(this,"isGeoDataInitialized",!1);n(this,"checkers",{device:e=>O(e),logged_in:(e,t)=>C(e,this.customerId),new_visitor:(e,t)=>x(e,t.visitorDetails,t.currentTime),returning_visitor:(e,t)=>q(e,t.visitorDetails,t.currentTime),url_contains:e=>j(e),referrer_contains:e=>Q(e),location:(e,t)=>N(e,t.geoData),b2b:e=>G(e,this.isB2B)});this.geoLocationApi=e.geoLocationApi,this.customerId=e.customerId,this.isB2B=e.isB2B,this.currentTime=Date.now(),this.initializeVisitorDetails()}initializeVisitorDetails(){var e;try{const t=localStorage.getItem(y.VISITOR_DETAILS_KEY);t&&(this.visitorDetails=JSON.parse(t),typeof((e=this.visitorDetails)==null?void 0:e.first_visit_timestamp)!="number"&&(console.warn("Invalid visitor details found in storage, resetting."),this.visitorDetails=null)),this.visitorDetails===null?(console.debug("Initializing new visitor details."),this.visitorDetails={first_visit_timestamp:this.currentTime},localStorage.setItem(y.VISITOR_DETAILS_KEY,JSON.stringify(this.visitorDetails))):console.debug("Loaded visitor details from storage:",this.visitorDetails)}catch(t){console.error("Error initializing visitor details:",t),localStorage.removeItem(y.VISITOR_DETAILS_KEY),this.visitorDetails={first_visit_timestamp:this.currentTime},localStorage.setItem(y.VISITOR_DETAILS_KEY,JSON.stringify(this.visitorDetails))}}check(e){const t=this.checkers[e.audience_type];if(!t)return console.warn(`Unknown audience type: ${e.audience_type}`),!1;e.audience_type==="location"&&(e.value=this.snakeCaseKeys(e.value),this.isGeoDataInitialized||(console.debug("Location check required, initializing geoData..."),this.internalGeoData=B(this.geoLocationApi),this.isGeoDataInitialized=!0,console.debug("GeoData initialization result:",this.internalGeoData)));const i={geoData:this.internalGeoData===void 0?null:this.internalGeoData,visitorDetails:this.visitorDetails,currentTime:this.currentTime};try{const r=!!t(e.value,i);return console.debug("Audience check result:",{audience:e,internalContext:i,matched:r}),e.condition==="is_not"?!r:r}catch(r){return console.error("Error during audience check:",{audience:e,internalContext:i,error:r}),!1}}snakeCaseKeys(e){if(typeof e!="object")return e;const t={};for(const[i,r]of Object.entries(e)){const a=i.replace(/[A-Z]/g,s=>`_${s.toLowerCase()}`);t[a]=r}return t}};n(y,"VISITOR_DETAILS_KEY","_shg_ab_visitor_details");let S=y;class ${constructor(e){n(this,"buyItNowHandlerAttached",!1);n(this,"currentPricingVariantId",null);n(this,"trackDispatchedSelection",(e,t)=>{const i=e&&e.isFirstAssignment===!1?"cache":t.distribution_method,r={shop_id:t.shop_id,optimization_id:e==null?void 0:e.optimization.id,variant_id:e==null?void 0:e.selectedVariant.id,details:{optimization_ids:t.optimization_ids,distribution_method:i,selection_details:t.selection_details,cache:t.cache,context:t.context,optimization_matches:t.optimization_matches}};this.trackingService.trackDispatch("dispatched",r)});this.trackingService=e,typeof document<"u"&&document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.attachPriceTestBuyItNowHandler()}):setTimeout(()=>{this.attachPriceTestBuyItNowHandler()},100)}attachPriceTestBuyItNowHandler(){if(this.buyItNowHandlerAttached)return;this.buyItNowHandlerAttached=!0;const e=async i=>{var s,o,h;const r=new FormData(i);if(!(r.get("id")||r.get("variant_id"))){const d="Unable to add item to cart. Please try again.";typeof((s=window.Shopify)==null?void 0:s.publish)=="function"?window.Shopify.publish("cart:error",{message:d}):alert(d);return}try{const d=this.currentPricingVariantId,f=await fetch("/cart/add.js",{method:"POST",headers:{Accept:"application/json"},body:r});if(!f.ok){let w="Unable to add item to cart. Please try again.";try{w=JSON.parse(await f.text()).description||w}catch{}typeof((o=window.Shopify)==null?void 0:o.publish)=="function"?window.Shopify.publish("cart:error",{message:w}):alert(w);return}d&&await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({attributes:{shogun_variant_id:d}})}),window.location.href="/checkout"}catch{const d="Unable to add item to cart. Please try again.";typeof((h=window.Shopify)==null?void 0:h.publish)=="function"?window.Shopify.publish("cart:error",{message:d}):alert(d)}};typeof document<"u"&&(()=>{document.addEventListener("click",i=>{const r=i.target;if(!r)return;const a=r.closest('[data-ab-price-test-payment-button="true"]');if(!a||!r.closest('shopify-buy-it-now-button, shopify-accelerated-checkout, [data-shopify="payment-button"]'))return;const o=a.closest("form");o&&(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),e(o))},{capture:!0})})()}extractViewParamFromFullTemplateKey(e){const t=e.split("/").pop().split(".");return t.slice(1,t.length-1).join(".")}async handleRedirect(e){const t=new URL(window.location.href),i=new URL(window.location.href);if(e.optimization.scope==="theme")i.searchParams.set("preview_theme_id",e.selectedVariant.config.theme_id);else if(e.optimization.scope==="url_redirect")i.pathname=e.languageRootUrl!=="/"?e.languageRootUrl+e.selectedVariant.config.path:e.selectedVariant.config.path;else{const r=this.extractViewParamFromFullTemplateKey(e.selectedVariant.config.full_template_key);i.searchParams.set("view",r)}t.toString()===i.toString()?this.hideViewParam():this.redirectWithoutCache(i)}hideViewParam(){const e=new URL(window.location.href);e.searchParams.delete("view"),window.history.replaceState({},"",e.toString())}dispatch(e,t,i){let r=null;if(e[0].optimization.scope=="price"){const a=e[0];if(r=a,this.currentPricingVariantId=t||a.selectedVariant.id,this.attachPriceTestBuyItNowHandler(),t)console.debug("shogun: price variant already assigned, returning");else{const s=a.selectedVariant.id;console.debug("shogun: assigning price variant");const o=JSON.stringify({attributes:{shogun_variant_id:s}}),h=new XMLHttpRequest;h.open("POST","/cart/update.js",!0),h.setRequestHeader("Content-Type","application/json"),h.onreadystatechange=()=>{if(h.readyState==4&&h.status==200){console.debug("shogun: reloading to reflect cart pricing");const d=new URL(window.location.href);this.redirectWithoutCache(d)}},h.send(o)}}else{const a=e.find(o=>o.matchingVariant.id!==o.selectedVariant.id);if(console.debug("redirectingSelection",a),a&&(a.optimization.scope!=="url_redirect"||a.isFirstAssignment===!0||a.optimization.config.permanent_redirect===!0))return this.trackDispatchedSelection(a,i),this.handleRedirect(a);const s=new Set(e.map(o=>o.optimization.scope));(s.has("template")||s.has("page"))&&this.hideViewParam(),r=e.find(o=>o.current())||a||null}e.length>0&&!r&&(r=e[0]),(r||e.length>0)&&this.trackDispatchedSelection(r,i),e.filter(a=>a.current()).forEach(a=>{this.trackingService.trackVariantImpression(a.selectedVariant,a.optimization.type)})}redirectWithoutCache(e){typeof e=="string"&&(e=new URL(e)),e.searchParams.delete("cache"),document.referrer!=""&&sessionStorage.setItem(E,document.referrer),console.debug("shogun: redirecting to ",e),window.location.replace(e)}}class b{constructor(e){n(this,"optimization");n(this,"matchingVariant");n(this,"selectedVariant");n(this,"isFirstAssignment");n(this,"languageRootUrl");this.optimization=e.optimization,this.matchingVariant=e.matchingVariant,this.selectedVariant=e.selectedVariant,this.isFirstAssignment=e.isFirstAssignment,this.languageRootUrl=e.languageRootUrl}current(){return this.matchingVariant.id===this.selectedVariant.id}}const v=class v{constructor(){n(this,"ran",!1)}removePreviewBarIframe(){console.debug("Setting up preview bar iframe removal");const e=()=>{v.PREVIEW_BAR_IFRAME_IDS.forEach(t=>{const i=document.getElementById(t);i&&(console.debug(`Removing preview bar iframe with id: ${t}`),i.remove())})};e(),document.addEventListener("DOMContentLoaded",()=>{console.debug("DOM loaded, setting up mutation observer for preview bar");const t=new MutationObserver(i=>{i.forEach(r=>{r.addedNodes.forEach(a=>{if(a.nodeType===Node.ELEMENT_NODE){const s=a;v.PREVIEW_BAR_IFRAME_IDS.includes(s.id)&&(console.debug(`Detected and removing preview bar iframe with id: ${s.id} via observer`),s.remove())}})})});if(document.body)t.observe(document.body,{childList:!0,subtree:!0});else{const i=new MutationObserver(()=>{document.body&&(t.observe(document.body,{childList:!0,subtree:!0}),e(),i.disconnect())});i.observe(document.documentElement,{childList:!0})}e()})}run(){this.ran||(this.removePreviewBarIframe(),this.ran=!0)}};n(v,"PREVIEW_BAR_IFRAME_IDS",["preview-bar-iframe","PBarNextFrameWrapper"]);let T=v;const D="_shg_analytics_queue";class K{enqueue(e){const t={...e,id:crypto.randomUUID(),attempts:0,createdAt:Date.now()},i=this.readQueue();return i[t.category].push(t),this.writeQueue(i),t}all(){const e=this.readQueue();return[...e.shogun_load,...e.dispatcher].sort((t,i)=>t.createdAt-i.createdAt)}update(e){const t=this.readQueue(),i=t[e.category],r=i.findIndex(a=>a.id===e.id);r!==-1&&(i[r]=e,this.writeQueue(t))}remove(e){const t=this.readQueue(),i=t[e.category],r=i.findIndex(a=>a.id===e.id);r!==-1&&(i.splice(r,1),this.writeQueue(t))}findLatest(e){const i=this.readQueue()[e];if(i.length!==0)return i[i.length-1]}readQueue(){const e=localStorage.getItem(D);if(!e)return this.emptyQueue();try{const t=JSON.parse(e);return t.shogun_load||(t.shogun_load=[]),t.dispatcher||(t.dispatcher=[]),t}catch(t){return console.error("shogun: failed to parse analytics queue storage, resetting",t),localStorage.removeItem(D),this.emptyQueue()}}writeQueue(e){try{localStorage.setItem(D,JSON.stringify(e))}catch(t){console.error("shogun: failed to save analytics queue",t)}}emptyQueue(){return{shogun_load:[],dispatcher:[]}}}const l=class l{constructor(e,t,i,r,a,s){n(this,"publishable",!1);n(this,"allowed",null);n(this,"eventQueue",new K);n(this,"processingQueue",!1);n(this,"pendingProcess",!1);n(this,"processTimer",null);n(this,"trackVariantImpression",(e,t)=>{const i={page_type:this.pageType,page_id:this.pageId,app_type:t=="ab_test"?"ab_testing":"personalization",original_referrer:this.originalReferrer};i.optimization_id=e.optimization_id,i.variant_id=e.id,console.debug(`Tracking variant impression: optimization=${e.optimization_id}, variant=${e.id}`),this.enqueueShogunLoadEvent(i)});n(this,"trackPage",()=>{const e={page_type:this.pageType,page_id:this.pageId,app_type:"ab_testing"};this.enqueueShogunLoadEvent(e)});n(this,"trackDispatch",(e,t)=>{this.enqueueEvent({category:"dispatcher",event:e,data:t})});n(this,"enqueueEvent",e=>{console.debug("shogun: enqueueing tracking event",{category:e.category,event:"event"in e?e.event:void 0}),e.category==="shogun_load"&&(!this.publishable||this.allowed!==!0)&&console.debug("shogun: not ready, enqueueing shogun:load event");try{this.eventQueue.enqueue(e),this.scheduleProcessQueue()}catch(t){console.error("shogun: failed to enqueue analytics event",t)}});n(this,"enqueueShogunLoadEvent",e=>{this.enqueueEvent({category:"shogun_load",data:e})});n(this,"waitForPublishable",()=>{var i,r;let e=0;const t=()=>{var a,s;if(typeof((s=(a=window.Shopify)==null?void 0:a.analytics)==null?void 0:s.publish)>"u")if(e<=l.retryAttemptsLimit){setTimeout(t,l.retryIntervalInMs);return}else console.warn("shogun:ts: Shopify analytics unavailable after 30s"),this.handleError("Error initializing TrackingService: Shopify analytics not available after 30s");console.debug("shogun:ts: publishable"),this.publishable=!0,this.scheduleProcessQueue()};(r=(i=window.Shopify)==null?void 0:i.analytics)!=null&&r.publish?(console.debug("shogun:ts: publishable"),this.publishable=!0):(console.debug("shogun:ts: analytics api not available yet, waiting..."),t())});n(this,"waitForConsent",()=>{var i,r;let e=0;const t=()=>{if(typeof window.Shopify>"u"&&e<=l.retryAttemptsLimit){setTimeout(t,l.retryIntervalInMs);return}window.Shopify.loadFeatures([{name:"consent-tracking-api",version:"0.1"}],a=>{var s;if(a&&a.length>0){let o=[];a.forEach(h=>{console.error(h),o.push(h.message)}),this.handleError(`Error initializing TrackingService: ${o.join(", ")}`)}else console.debug("shogun:ts: consent available"),this.handleConsentChange(((s=window.Shopify.customerPrivacy)==null?void 0:s.analyticsProcessingAllowed())??!1)})};(r=(i=window.Shopify)==null?void 0:i.customerPrivacy)!=null&&r.analyticsProcessingAllowed?(console.debug("shogun:ts: consent available"),this.allowed=window.Shopify.customerPrivacy.analyticsProcessingAllowed()):(console.debug("shogun:ts: privacy api not available yet, waiting..."),t())});n(this,"handleConsentChange",e=>{this.allowed=e,console.debug("shogun: analytics consent updated to: ",this.allowed),this.scheduleProcessQueue()});n(this,"scheduleProcessQueue",()=>{if(this.processingQueue){this.pendingProcess=!0;return}this.processingQueue=!0;try{this.processQueue()}catch(e){console.error("shogun: error processing analytics queue",e)}finally{this.processingQueue=!1,this.pendingProcess&&(this.pendingProcess=!1,this.scheduleProcessQueue())}});n(this,"scheduleProcessQueueAfter",e=>{this.processTimer||(this.processTimer=setTimeout(()=>{this.processTimer=null,this.scheduleProcessQueue()},e))});n(this,"handleError",e=>{let t,i;const r=this.eventQueue.findLatest("shogun_load");r&&(t=r.data.optimization_id,i=r.data.variant_id),this.trackDispatchFallback("errored",{shop_id:this.shopId,dispatcher_session_id:this.dispatcherSessionId,optimization_id:t,variant_id:i,details:{error:e}})});n(this,"dispatcherFallbackReady",e=>e.category!=="dispatcher"?!1:Date.now()-e.createdAt>=l.dispatchFallbackDelayInMs);n(this,"trackDispatchFallback",(e,t)=>{console.debug(`shogun: sending dispatch:${e} via fallback`),t.name=e,fetch(`${this.analyticsUrl}/dispatcher/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0})});n(this,"prepareFallbackPayload",e=>{const t=this.clonePayload(e);return t.shop_id=t.shop_id||this.shopId,t.dispatcher_session_id=this.dispatcherSessionId,t.details||(t.details={}),t});n(this,"clonePayload",e=>{try{return JSON.parse(JSON.stringify(e))}catch{return e}});this.shopId=e,this.pageType=t,this.pageId=i,this.originalReferrer=r,this.analyticsUrl=a,this.dispatcherSessionId=s,this.waitForPublishable(),this.waitForConsent(),document.addEventListener("visitorConsentCollected",o=>{this.handleConsentChange(o.detail.analyticsAllowed)}),this.scheduleProcessQueue()}processQueue(){console.debug("shogun: processing queue");const e=this.eventQueue.all();let t=!1;for(const i of e){if(this.shouldDropEvent(i)){this.eventQueue.remove(i);continue}if(this.isWithinBackoffWindow(i)){t=!0;continue}if(!this.isEventReady(i)){t=!0;continue}let r="success";try{r=this.deliverEvent(i)}catch(a){console.error("shogun: error delivering analytics event",a),r="retry"}r==="success"||r==="drop"?this.eventQueue.remove(i):(i.attempts+=1,i.lastAttemptedAt=Date.now(),this.eventQueue.update(i),t=!0)}t&&this.scheduleProcessQueueAfter(l.queueRetryDelayInMs)}shouldDropEvent(e){return Date.now()-e.createdAt>l.maxQueueAgeInMs||e.attempts>=l.maxQueueAttempts||e.category==="dispatcher"&&!e.event}isWithinBackoffWindow(e){if(!e.lastAttemptedAt)return!1;const t=l.queueRetryDelayInMs*Math.pow(2,Math.min(e.attempts,l.maxQueueAttempts));return Date.now()-e.lastAttemptedAt<t}isEventReady(e){return e.category==="shogun_load"?this.publishable&&this.allowed===!0:e.category==="dispatcher"?this.allowed===!0&&this.publishable?!0:this.dispatcherFallbackReady(e):!1}deliverEvent(e){return e.category==="shogun_load"?this.deliverShogunLoad(e):this.deliverDispatch(e)}deliverShogunLoad(e){const t=e.data;try{return console.debug("Firing shogun:load event",t),window.Shopify.analytics.publish("shogun:load",t),"success"}catch(i){return console.error("Error publishing shogun:load event:",i),"retry"}}deliverDispatch(e){if(e.category!=="dispatcher"||!e.event)return"drop";if(this.allowed===!0&&this.publishable){const i=`shogun:dispatcher:${e.event}`;try{return console.debug(`Firing ${i} event`,e.data),window.Shopify.analytics.publish(i,e.data),"success"}catch(r){console.error(`Error publishing ${i} event:`,r);const a=this.prepareFallbackPayload(e.data);return a.details||(a.details={}),a.details.error=`Error publishing ${i} event: ${r.message}`,this.trackDispatchFallback(e.event,a),"success"}}if(!this.dispatcherFallbackReady(e))return"retry";const t=this.prepareFallbackPayload(e.data);return this.trackDispatchFallback(e.event,t),"success"}};n(l,"retryIntervalInMs",250),n(l,"retryAttemptsLimit",3e4/l.retryIntervalInMs),n(l,"queueRetryDelayInMs",1e3),n(l,"maxQueueAttempts",5),n(l,"maxQueueAgeInMs",24*60*60*1e3),n(l,"dispatchFallbackDelayInMs",30*1e3);let A=l;const E="_shg_referrer",u=class u{constructor(e){n(this,"shopId");n(this,"optimizations");n(this,"currentThemeId");n(this,"pageId");n(this,"pageType");n(this,"currentPartialTemplateKey");n(this,"distributionMethod");n(this,"cachedOptimizations");n(this,"audienceChecker");n(this,"personalizations");n(this,"abTests");n(this,"dispatcher");n(this,"trackingService");n(this,"currentPath");n(this,"themeTestHandler");n(this,"currentPricingVariantId");n(this,"languageRootUrl");n(this,"dispatcherSessionId");n(this,"originalReferrer");n(this,"inAudience",e=>this.audienceChecker.check(e));if(this.originalReferrer=sessionStorage.getItem(E),this.originalReferrer){sessionStorage.removeItem(E),console.debug("shogun: retaining original referrer: ",this.originalReferrer);try{Object.defineProperty(document,"referrer",{get:()=>this.originalReferrer})}catch(s){console.debug("shogun: failed to set original referrer via `Object.defineProperty`"),console.error(s);try{window.document.__defineGetter__("referrer",()=>this.originalReferrer)}catch(o){console.debug("shogun: failed to set original referrer via `__defineGetter__`"),console.error(o)}}}this.shopId=e.shopId,this.currentThemeId=e.currentThemeId,this.currentPricingVariantId=e.currentPricingVariantId;const t=e.optimizations||[];e.defaultThemeId!==this.currentThemeId?this.optimizations=t.filter(s=>s.scope==="price"||s.variants.some(o=>o.config.theme_id===this.currentThemeId)):this.optimizations=t,this.personalizations=this.optimizations.filter(s=>s.type==="personalization"),this.abTests=this.optimizations.filter(s=>s.type==="ab_test"),this.distributionMethod=e.distributionMethod||u.DEFAULT_DISTRIBUTION_METHOD,this.pageId=e.pageId,this.pageType=e.pageType,this.languageRootUrl=e.languageRootUrl;const i=this.pageType==="metaobject"?"templates/metaobject/":"templates/",r=[e.templateName,e.templateSuffix].filter(Boolean).join(".");this.currentPartialTemplateKey=i+r,this.currentPath=window.location.pathname,this.cachedOptimizations=JSON.parse(localStorage.getItem(u.OPTIMIZATIONS_CACHE_KEY)||"{}"),this.audienceChecker=new S(e),e.sessionIdOverride?this.dispatcherSessionId=e.sessionIdOverride:(this.dispatcherSessionId=V.get(u.DISPATCHER_SESSION_COOKIE)||crypto.randomUUID(),V.set(u.DISPATCHER_SESSION_COOKIE,this.dispatcherSessionId,{path:"/",expires:1/48})),this.trackingService=new A(this.shopId,this.pageType,this.pageId,this.originalReferrer,e.analyticsUrl,this.dispatcherSessionId);const a=new T;this.themeTestHandler=a,this.dispatcher=new $(this.trackingService)}getOptimizationPriority(e){return{theme:1,template:2,page:3,url_redirect:4,price:5}[e.scope]}sortMatches(e){return[...e].sort((t,i)=>{const r=this.getOptimizationPriority(t.optimization),a=this.getOptimizationPriority(i.optimization);return r===a?0:r-a})}audienceMatchesCurrentVisitor(e){const t=e.audiences||[];return t.length===0?!0:e.audiences_condition==="any"?t.some(this.inAudience):t.every(this.inAudience)}configAudiencesMatch(e,t){const i=e.audiences||[],r=t.audiences||[];if(i.length!==r.length)return!1;const a=i.map(o=>JSON.stringify(o)),s=r.map(o=>JSON.stringify(o));return!(a.some(o=>!s.includes(o))||s.some(o=>!a.includes(o))||i.length>1&&e.audiences_condition!==t.audiences_condition)}getCachedVariant(e){const t=this.cachedOptimizations[e.id];if(t)return e.variants.find(i=>i.id===t)}setCachedVariant(e,t){this.cachedOptimizations[e.id]=t.id,console.debug("setCachedVariant",e.id,t.id),localStorage.setItem(u.OPTIMIZATIONS_CACHE_KEY,JSON.stringify(this.cachedOptimizations))}extractPartialTemplateKeyFromFullTemplateKey(e){if(!e)return;const t=e.split(".");return t.length<2?e:t.slice(0,-1).join(".")}matchesAnyAttributeOfCurrentPage(e,t){const i=this.checkTemplateMatch(t),r=this.checkThemeMatch(e,t),a=this.checkPageMatch(e),s=this.checkPathMatch(t),o=this.checkPriceMatch(e,t);return r||i&&a||s||o}getMatchingVariant(e,t=void 0){var a;const i=e.config,r=(a=t==null?void 0:t.selectedVariant)==null?void 0:a.config;for(const s of e.variants){if(!this.matchesAnyAttributeOfCurrentPage(e,s))continue;const o=e.type==="ab_test"?e.config:s.config;if(this.audienceMatchesCurrentVisitor(o)&&!(r&&!this.configAudiencesMatch(i,r)))return s}}getPersonalizationMatches(){const e=[];for(const t of this.personalizations){const i=this.getMatchingVariant(t);i&&e.push({optimization:t,matchingVariant:i})}return e}getPrioritizedNonDefaultPersonalizationSelection(){const e=this.getPersonalizationMatches();if(e.length===0)return;const t=this.sortMatches(e);for(const i of t){const a=i.optimization.variants.sort((s,o)=>s.position-o.position).find(s=>!s.config.original&&this.audienceMatchesCurrentVisitor(s.config));if(a)return new b({optimization:i.optimization,matchingVariant:i.matchingVariant,selectedVariant:a,isFirstAssignment:!0,languageRootUrl:this.languageRootUrl})}}getDefaultPersonalizationSelectionsForImpressionTracking(e){return this.getPersonalizationMatches().filter(r=>r.matchingVariant.config.original&&r.optimization.id!==(e==null?void 0:e.optimization.id)).map(r=>new b({optimization:r.optimization,matchingVariant:r.matchingVariant,selectedVariant:r.matchingVariant,isFirstAssignment:!0,languageRootUrl:this.languageRootUrl}))}getRandomVariantForOptimization(e){const t=`${this.dispatcherSessionId}-${e.id}`,r=this.hashWithDjb2(t)%u.DEFAULT_NUMBER_OF_BINS;let a=0;for(const s of e.variants)if(a+=u.DEFAULT_NUMBER_OF_BINS*(s.config.percentage||0)/100,r<a)return s;return e.variants[0]}hasAnyCachedVariants(){return this.abTests.some(e=>!!this.cachedOptimizations[e.id])}getGreedySelections(e){const t=e[Math.floor(Math.random()*e.length)],i=t.cachedVariant||this.getRandomVariantForOptimization(t.optimization);return[new b({optimization:t.optimization,matchingVariant:t.matchingVariant,selectedVariant:i,isFirstAssignment:!t.cachedVariant,languageRootUrl:this.languageRootUrl})]}userBin(){const e=this.dispatcherSessionId;return e?this.hashWithDjb2(e)%u.DEFAULT_NUMBER_OF_BINS:0}hashWithDjb2(e){let t=5381;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return Math.abs(t)}getVariantForUserBin(){const e=this.userBin(),t=this.abTests.flatMap(r=>r.variants);let i=0;for(const r of t)if(i+=u.DEFAULT_NUMBER_OF_BINS*(r.traffic_percentage||0)/100,e<i)return r;return null}getEvenSelections(e){const t=this.getVariantForUserBin();if(!t)return[];const i=e.find(r=>r.optimization.variants.some(a=>a.id===t.id));return i?[new b({optimization:i.optimization,matchingVariant:i.matchingVariant,selectedVariant:t,isFirstAssignment:!i.cachedVariant,languageRootUrl:this.languageRootUrl})]:[]}getAbTestMatches(e){const t=[];return this.abTests.forEach(i=>{const r=this.getMatchingVariant(i,e);if(r){const a=this.getCachedVariant(i);(r.config.original||a)&&t.push({optimization:i,matchingVariant:r,cachedVariant:a})}}),t}getAbTestSelections(e){const t=this.getAbTestMatches(e);if(t.length===0)return[];const i=t.find(r=>!!r.cachedVariant);if(!i&&this.hasAnyCachedVariants())return[];if(i)return[new b({optimization:i.optimization,matchingVariant:i.matchingVariant,selectedVariant:i.cachedVariant,isFirstAssignment:!1,languageRootUrl:this.languageRootUrl})];switch(this.distributionMethod){case"greedy":return this.getGreedySelections(t);case"even":return this.getEvenSelections(t);default:throw new Error(`Unknown distribution method: ${this.distributionMethod}`)}}isBot(){const e=navigator.userAgent,t=z(e);return console.debug("Bot testing with user agent:",e),t}handleThemeReview(){const t=new URLSearchParams(location.search).get("shgpvid"),i=sessionStorage.getItem("_shg_preview_variant_id");if(i&&(!t||i==t)){console.debug(`shogun: theme review in progress, viewing variant: ${i}`);const r=document.getElementById("shogun-price-test-preview");if(!r){console.debug("shogun: sidebar not found!!!");return}const a=r.content.cloneNode(!0);document.addEventListener("DOMContentLoaded",()=>{document.body.style.paddingLeft="32rem",document.body.prepend(a)});return}else if(t&&(!i||i!=t)){console.debug(`shogun: theme review in progress, setting variant: ${t}`),sessionStorage.setItem("_shg_preview_variant_id",t);const r=JSON.stringify({attributes:{shogun_variant_id:t}}),a=new XMLHttpRequest;a.open("POST","/cart/update.js",!0),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=()=>{a.readyState==4&&a.status==200&&(console.debug("shogun: reloading to reflect cart pricing"),location=location)},a.send(r)}}run(){let e=null,t=this.distributionMethod,i=[];const r=(a,s={})=>{var h,d;const o=a&&a.isFirstAssignment===!1?"cache":t;return{shop_id:this.shopId,optimization_id:(h=a==null?void 0:a.optimization)==null?void 0:h.id,variant_id:(d=a==null?void 0:a.selectedVariant)==null?void 0:d.id,details:{optimization_ids:this.optimizations.map(f=>f.id),distribution_method:o,selection_details:i,...s}}};try{if(this.isBot()){console.debug("Bot traffic detected, optimizer disabled");return}this.handleThemeReview();const a=this.getPrioritizedNonDefaultPersonalizationSelection(),s=this.getAbTestSelections(a),o=[];a&&o.push(a),o.push(...s),o.push(...this.getDefaultPersonalizationSelectionsForImpressionTracking(a)),localStorage.getItem("_shg_is_merchant")||this.themeTestHandler.run(),e=o.find(d=>d.matchingVariant.id===d.selectedVariant.id)||null,e&&!e.isFirstAssignment&&(t="cache"),i=o.map(d=>({optimization_id:d.optimization.id,selected_variant_id:d.selectedVariant.id,matching_variant_id:d.matchingVariant.id}));const h={shop_id:this.shopId,optimization_ids:this.optimizations.map(d=>d.id),selection_details:i,distribution_method:t,cache:{...this.cachedOptimizations},context:{template_key:this.currentPartialTemplateKey,theme_id:this.currentThemeId,page_type:this.pageType,page_id:this.pageId},optimization_matches:this.buildOptimizationMatches(a)};if(s.forEach(d=>{this.setCachedVariant(d.optimization,d.selectedVariant)}),o.length===0){this.abTests.length>0&&(this.trackingService.trackPage(),this.trackingService.trackDispatch("skipped",r(e)));return}this.dispatcher.dispatch(o,this.currentPricingVariantId,h)}catch(a){this.trackingService.trackDispatch("errored",r(e,{error:a.message}))}}getCurrentPathWithoutLanguagePrefix(){return this.languageRootUrl==="/"||!this.currentPath.startsWith(this.languageRootUrl)?this.currentPath:this.currentPath.substring(this.languageRootUrl.length)||"/"}checkTemplateMatch(e){return this.extractPartialTemplateKeyFromFullTemplateKey(e.config.full_template_key)===this.currentPartialTemplateKey}checkThemeMatch(e,t){return e.scope==="theme"&&t.config.theme_id===this.currentThemeId}checkPageMatch(e){const{page_type:t,page_id:i}=e.config,r=!t||t===this.pageType,a=!i||i===this.pageId;return e.scope!=="url_redirect"&&r&&a}checkPathMatch(e){const t=e.config.path;if(!t)return!1;const i=this.getCurrentPathWithoutLanguagePrefix();return decodeURIComponent(t)===decodeURIComponent(i)}checkPriceMatch(e,t){return e.scope!=="price"?!1:!this.currentPricingVariantId||this.currentPricingVariantId===t.id}getDetailedMatchingInfo(e,t,i){const{page_type:r,page_id:a}=e.config,s=!r||r===this.pageType,o=!a||a===this.pageId,h=e.type==="ab_test"?e.config:t.config,d=i?this.configAudiencesMatch(e.config,i.selectedVariant.config):!1;return{matches_template:this.checkTemplateMatch(t),matches_theme:this.checkThemeMatch(e,t),matches_page_type:s,matches_page_id:o,matches_page:this.checkPageMatch(e),matches_path:this.checkPathMatch(t),matches_price:this.checkPriceMatch(e,t),matches_audience:this.audienceMatchesCurrentVisitor(h),matches_personalization_config:d}}buildOptimizationMatches(e){const t={};for(const i of this.optimizations)if(t[i.id]={},i.variants&&Array.isArray(i.variants))for(const r of i.variants)t[i.id][r.id]=this.getDetailedMatchingInfo(i,r,e);return t}};n(u,"DEFAULT_NUMBER_OF_BINS",1e4),n(u,"DEFAULT_DISTRIBUTION_METHOD","greedy"),n(u,"OPTIMIZATIONS_CACHE_KEY","_shg_ab_optimizations_cache"),n(u,"DISPATCHER_SESSION_COOKIE","_shg_dispatcher_session");let k=u;window.ShogunOptimizer=k})();

</script>

{%- assign shogun_variant_id = cart.attributes.shogun_variant_id -%}
{%- assign optimizer_supports_klarna = false -%}
{%- if shop.enabled_payment_types != blank -%}
  {%- for payment_type in shop.enabled_payment_types -%}
    {%- assign payment_type_downcase = payment_type | downcase -%}
    {%- if payment_type_downcase contains 'klarna' -%}
      {%- assign optimizer_supports_klarna = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- if optimizer_supports_klarna == false and shop.enabled_payment_gateways != blank -%}
  {%- for payment_gateway in shop.enabled_payment_gateways -%}
    {%- assign gateway_name = payment_gateway.name | default: payment_gateway -%}
    {%- assign gateway_value = gateway_name | downcase -%}
    {%- if gateway_value contains 'klarna' -%}
      {%- assign optimizer_supports_klarna = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- if shogun_variant_id != nil -%}
  {%- assign price_tests = shop.metafields.app--214825828353.price-tests -%}
  {%- assign optimization_config = nil -%}
  {% for optimization in shop.metafields.app--214825828353.price-tests.value %}
    {% for variants in optimization.variants %}
      {% if variants.id == shogun_variant_id %}
        {% assign optimization_config = optimization %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  {%- assign default_price_change = 0 -%}
  {%- assign image_size = 40 -%}
  {%- assign arrow_symbol = '<svg xmlns="http://www.w3.org/2000/svg" width="10" height="12" viewBox="0 0 10 12" fill="none"><path d="M4.92296 10.5227C4.55973 10.8482 4.55973 11.3758 4.92296 11.7012C5.28619 12.0267 5.8751 12.0267 6.23833 11.7012L9.33869 8.92346C9.70192 8.59802 9.70192 8.07038 9.33869 7.74494L6.23833 4.96717C5.8751 4.64173 5.28619 4.64173 4.92296 4.96717C4.55973 5.2926 4.55973 5.82024 4.92296 6.14568L6.43552 7.50087L4.65054 7.50087C3.10948 7.50087 1.86021 6.38158 1.86021 5.00087L1.86021 0.834201C1.86021 0.373964 1.44379 0.000867717 0.930106 0.000867762C0.416423 0.000867807 -4.79388e-07 0.373964 -4.39152e-07 0.834201L-6.07103e-07 5.00087C-4.05927e-07 7.30205 2.08212 9.16753 4.65054 9.16753L6.43552 9.16753L4.92296 10.5227Z" fill="#4A4A4A"/></svg>' -%}
  {%- assign caret_symbol = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.23966 11.7996C6.5432 12.0814 7.01775 12.0639 7.2996 11.7603L10 8.85221L12.7004 11.7603C12.9823 12.0639 13.4568 12.0814 13.7603 11.7996C14.0639 11.5177 14.0815 11.0432 13.7996 10.7397L10.5496 7.23966C10.4077 7.08683 10.2086 7 10 7C9.79145 7 9.59232 7.08683 9.45041 7.23966L6.20041 10.7397C5.91856 11.0432 5.93613 11.5177 6.23966 11.7996Z" fill="#4A4A4A"/></svg>' -%}

   {% if product %}
    {%- assign shogun_price_namespace = 'app--214825828353' -%}
    {%- assign product_pricing_metafield = product.metafields[shogun_price_namespace]['product-pricing'] -%}

    <!-- Primary payload: per-variant metafields + product-level default -->
    <script type="application/json" id="shg-price-test-pricing">
      {
        "shogunVariantId": {{ shogun_variant_id | json }},
        "variants": {
          {% for variant in product.variants %}
            {% assign shogun_variant_pricing = variant.metafields[shogun_price_namespace]['product-variant-pricing'] %}
            "{{ variant.id }}": {% if shogun_variant_pricing %}{{ shogun_variant_pricing.value | json }}{% else %}null{% endif %}{% unless forloop.last %},{% endunless %}
          {% endfor %}
        },
        "productPricing": {% if product_pricing_metafield %}{{ product_pricing_metafield.value | json }}{% else %}null{% endif %}
      }
    </script>

    {%- comment -%}
      Fallback payload: build from optimization_config for THIS product (covers draft preview & cases where metafields aren't present)
    {%- endcomment -%}
    {% assign current_product_config = nil %}
    {% if optimization_config %}
      {% for p in optimization_config.products %}
        {% if p.id == product.id %}
          {% assign current_product_config = p %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if current_product_config %}
      <script type="application/json" id="shg-price-test-pricing-fallback">
        {
          "shogunVariantId": {{ shogun_variant_id | json }},
          "variantPricing": {
            {% for vp in current_product_config.variant_pricing %}
              "{{ vp.id }}": { "test_price": {{ vp.test_price | json }}, "original_price": {{ vp.original_price | json }} }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          }
        }
      </script>
    {% endif %}

  {% endif %}

  {% if optimizer_supports_klarna %}
    <script>
(function () {
  if (window.__shgKlarnaLite) return;

  // ---------- tiny helpers ----------
  function isArray(v){ return Array.isArray ? Array.isArray(v) : Object.prototype.toString.call(v)==='[object Array]'; }
  function findEntry(list, pred){ if(!isArray(list)) return null; for(var i=0;i<list.length;i++) if(pred(list[i])) return list[i]; return null; }
  function toCents(x){ var n = Math.round(parseFloat(x) * 100); return (isFinite(n) && n >= 0) ? n : null; }

  // ---------- read test amount from your JSON blobs ----------
  var dataNode = document.getElementById('shg-price-test-pricing');
  var defaultCents = null;     // chosen product price (your test price)
  var priceMap = {};           // per-variant overrides if provided

  if (dataNode) {
    try {
      var payload = JSON.parse(dataNode.textContent || dataNode.innerHTML || '{}');

      // 1) Main product price (chosen/test price for this shogunVariantId)
      if (payload && payload.shogunVariantId && isArray(payload.productPricing)) {
        var chosen = findEntry(payload.productPricing, function (e){ return e.shogun_variant_id === payload.shogunVariantId; })
                 || findEntry(payload.productPricing, function (e){ return e.original; });
        if (chosen && chosen.price != null) defaultCents = toCents(chosen.price);
      }

      // 2) Optional per-variant map (if present)
      var variants = (payload && payload.variants) || {};
      Object.keys(variants).forEach(function(vid){
        var entries = variants[vid];
        if (!isArray(entries)) return;
        var match = findEntry(entries, function (e){return e.shogun_variant_id === payload.shogunVariantId;})
                 || findEntry(entries, function (e){return e.original;});
        if (match && match.price != null) {
          var cents = toCents(match.price);
          if (cents != null) priceMap[String(vid)] = cents;
        }
      });
    } catch(_){}
  }

  // Fallback blob (optional)
  if (!Object.keys(priceMap).length && defaultCents == null) {
    var fb = document.getElementById('shg-price-test-pricing-fallback');
    if (fb) {
      try {
        var fbPayload = JSON.parse(fb.textContent || '{}');
        if (fbPayload && fbPayload.variantPricing) {
          Object.keys(fbPayload.variantPricing).forEach(function(id){
            var vp = fbPayload.variantPricing[id];
            var chosen = (vp && (vp.test_price != null ? vp.test_price : vp.original_price));
            var c = toCents(chosen);
            if (c != null) priceMap[String(id)] = c;
          });
        }
      } catch(_){}
    }
  }

  // Final amount resolver:
  function resolveOverrideCents(){
    if (typeof defaultCents === 'number') return defaultCents;
    var ids = Object.keys(priceMap);
    if (ids.length) return priceMap[ids[0]];
    return null;
  }

  // ---------- (A) keep DOM placements in sync ----------
  function resyncDom(){
    var amt = resolveOverrideCents();
    if (amt == null) return;

    // Set both DOM attributes (safe on DOM)
    var nodes = document.querySelectorAll('klarna-placement,[data-klarna-osm]');
    for (var i=0;i<nodes.length;i++){
      nodes[i].setAttribute('data-purchase-amount', String(amt));
      nodes[i].setAttribute('data-payment-amount',  String(amt));
    }

    // Nudge OSM to re-render with the enforced amount
    try {
      if (window.KlarnaOnsiteService && typeof window.KlarnaOnsiteService.push === 'function') {
        window.KlarnaOnsiteService.push({ event: 'update', purchaseAmount: amt, paymentAmount: amt });
      }
    } catch(_){}
  }

  // Guard direct attribute writes so Klarna can't revert them
  (function patchSetAttribute(){
    var proto = Element.prototype;
    var orig = proto.setAttribute;
    if (!orig || proto.__shgSetAttrPatched) return;
    proto.setAttribute = function(name, value){
      try {
        var n = String(name || '').toLowerCase();
        if ((this && this.nodeType === 1) && (n === 'data-purchase-amount' || n === 'purchase-amount' || n === 'data-payment-amount' || n === 'payment-amount')) {
          var amt = resolveOverrideCents();
          return orig.call(this, name, String(amt != null ? amt : value));
        }
      } catch(_){}
      return orig.call(this, name, value);
    };
    proto.__shgSetAttrPatched = true;
  })();

  // Snap back any attribute changes (e.g., after modal closes)
  (function installObserver(){
    try {
      var obs = new MutationObserver(function(records){
        var amt = resolveOverrideCents();
        if (amt == null) return;
        for (var i=0;i<records.length;i++){
          var r = records[i];
          if (r.type !== 'attributes' || !r.target) continue;
          var name = (r.attributeName || '').toLowerCase();
          if (name && (name === 'data-purchase-amount' || name === 'purchase-amount' || name === 'data-payment-amount' || name === 'payment-amount')) {
            var cur = r.target.getAttribute(r.attributeName);
            var want = String(amt);
            if (cur !== want) r.target.setAttribute(r.attributeName, want);
          }
        }
      });
      obs.observe(document.documentElement, {
        subtree: true,
        attributes: true,
        attributeFilter: ['data-purchase-amount','purchase-amount','data-payment-amount','payment-amount']
      });
    } catch(_){}
  })();

  // ---------- (B) force amount in Klarna network calls (no duplicates) ----------
  function whichAmountKey(url){
    // Prefer the key already present; otherwise infer from placement_key
    if (url.searchParams.has('purchase_amount')) return 'purchase_amount';
    if (url.searchParams.has('payment_amount'))  return 'payment_amount';

    var pk = url.searchParams.get('placement_key') || '';
    // Known defaults:
    if (/payment-calculator-interstitial/i.test(pk)) return 'purchase_amount';
    if (/credit-promotion-badge/i.test(pk))         return 'payment_amount';

    // Fallback: default to purchase_amount
    return 'purchase_amount';
  }

  function forceAmountInUrl(u){
    try{
      var url = (u instanceof Request) ? new URL(u.url, location.href) : new URL(String(u), location.href);
      var isKlarnaMsg = /js\.klarna\.com.*\/(cma|eu\/cma)\/v\d+\/messaging/i.test(url.href) || /klarna.*\/messaging/i.test(url.href);
      if (!isKlarnaMsg) return null;

      var amt = resolveOverrideCents();
      if (amt == null) return null;

      // Decide exactly ONE param to set
      var key = whichAmountKey(url);
      url.searchParams.set(key, String(amt));

      // And IMPORTANT: remove the other key if present to avoid "duplicated" error
      var other = key === 'purchase_amount' ? 'payment_amount' : 'purchase_amount';
      url.searchParams.delete(other);

      return url.toString();
    }catch(_){ return null; }
  }

  // fetch() patch
  (function patchFetch(){
    try {
      var _fetch = window.fetch;
      if (typeof _fetch === 'function' && !_fetch.__shgPatched) {
        window.fetch = function(input, init){
          try{
            var forced = forceAmountInUrl(input);
            if (forced) {
              if (input instanceof Request) {
                input = new Request(forced, input);
              } else {
                input = forced;
              }
            }
          }catch(_){}
          return _fetch.call(this, input, init);
        };
        window.fetch.__shgPatched = true;
      }
    } catch(_){}
  })();

  // XHR patch
  (function patchXHR(){
    try {
      var _open = XMLHttpRequest.prototype.open;
      var _send = XMLHttpRequest.prototype.send;

      if (!_open.__shgPatched) {
        XMLHttpRequest.prototype.open = function(method, url, async, user, password){
          try{ this.__shgForcedUrl = forceAmountInUrl(url) || null; }catch(_){}
          this._lastMethod = method;
          return _open.apply(this, arguments);
        };
        _open.__shgPatched = true;
      }

      if (!_send.__shgPatched) {
        XMLHttpRequest.prototype.send = function(body){
          try{
            if (this.__shgForcedUrl) {
              _open.call(this, this._lastMethod || 'GET', this.__shgForcedUrl, true);
            }
          }catch(_){}
          return _send.apply(this, arguments);
        };
        _send.__shgPatched = true;
      }
    } catch(_){}
  })();

  // ---------- (C) kick + keep things fresh around modal lifecycle ----------
  function kick(){
    resyncDom();
  }

  // Initial + a short burst to catch late mounts
  kick();
  var end = Date.now() + 6000;
  (function loop(){
    kick();
    if (Date.now() < end) requestAnimationFrame(loop);
  })();

  // When focus returns / tab visible (often right after modal closes)
  document.addEventListener('visibilitychange', function(){ if (!document.hidden) kick(); }, { passive: true });
  window.addEventListener('focus', kick, { passive: true });

  // Variant selectors often fire "change"
  document.addEventListener('change', function(e){
    if ((e.target && /variant|size|color|option/i.test(String(e.target.name||''))) || e.isTrusted) kick();
  }, { passive: true });

  window.__shgKlarnaLite = true;
})();
</script>

  {% endif %}

  {% if optimization_config and optimization_config.status == "draft" %}
    <template id="shogun-price-test-preview">
      <style>
        .shogun-price-test-preview-sidebar {
          position: fixed;
          width: 32rem;
          top: 0;
          background-color: white;
          height: 100%;
          left: 0;
          line-height: 2rem;
          overflow-y: auto;
        }

        .shogun-price-test-preview-sidebar-header {
          border: 1px solid #e5e7eb;
          background-color: #CAE6FF;
          font-size: 1rem;
          display: flex;
          flex-direction: column;
          margin: 10px;
          border-radius: 10px;
        }

        .shogun-price-test-preview-sidebar-title {
          font-weight: 650;
          color: #251A00;
          padding: 12px 16px;
        }

        .shogun-price-test-preview-sidebar-description {
          font-size: 1rem;
          color: #303030;
          padding: 12px 8px;
          background-color: #FFFFFF;
          border-radius: 0 0 12px 12px;
        }

        .shogun-price-test-preview-sidebar-content {
          padding: 0 1rem;
          font-size: 1rem;
          color: #303030;
        }

        .shogun-price-test-preview-sidebar-contact-support-button {
          background: #FFFFFF;
          color: #303030;
          font-weight: 550;
          font-size: 1rem;
          border-radius: 8px;
          padding: 6px 12px;
          cursor: pointer;
          border: 1px solid #e5e7eb;
          margin-top: 4px;
          
          &:hover {
            background: #303030;
            color: #FFFFFF;
          }
        }
          
        .shogun-price-test-preview-sidebar-product-collection-container {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: flex-start;
          gap: 0.5rem;
          color: #303030;
        }

        .shogun-price-test-preview-sidebar-product-collection-header {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          padding: 0.5rem 0;
          gap: 0.8rem;
        }

        .shogun-price-test-preview-sidebar-product-collection-header-child {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 0.75rem;
          min-width: 150px;
          justify-content: flex-end;
        }

        .shogun-price-test-preview-sidebar-image-container {
          flex: none;
          box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.08);
          border-radius: 0.5rem;

          img {
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            vertical-align: middle;
          }
        }

        .shogun-price-test-preview-sidebar-title-container {
          flex: 1;
          font-size: 1rem;
          font-weight: 550;

          span {
            vertical-align: middle;
          }
        }

        .shogun-price-test-preview-sidebar-product-collection-item-container {
          width: 100%;
        }

        .shogun-price-test-preview-sidebar-product-collection-caret {
          background: none;
          border: none;
          cursor: pointer;
          padding: 0;
          height: 2rem;
          font-size: 1rem;
          color: #6b7280;
          transition: transform 0.3s ease-in-out;

          &:hover {
            color: #374151;
          }

          &.collapsed {
            transform: rotate(180deg);
          }
        }

        .shogun-price-test-preview-sidebar-collection-badge {
          padding: 0.20rem 0.8rem;
          border-radius: 1rem;
          font-size: 1rem;
          font-weight: 550;
          color: #00527C;
          background-color: #E0F0FF;
          line-height: 1.5rem;
        }

        .shogun-price-test-preview-sidebar-currency-info {
          background-color: #f3f4f6;
          color: #374151;
          margin: 10px 0;
          border-radius: 10px;
          text-align: center;
          font-weight: 550;
          font-size: 12px;
          padding: 4px 8px;
          width: fit-content;
          line-height: normal;
        }

        .shogun-price-test-preview-sidebar-count-badge {
          color: #5700D1;
          background: #F8F7FF;
          border: 1px solid #5700D1;
          border-radius: 0.5rem;
          padding: 0.20rem 0.8rem;
          font-size: 1rem;
          line-height: 1.5rem;
          font-weight: 550;
        }

        .shogun-price-test-preview-sidebar-product-collection-children {
          margin-left: 1.5rem;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          overflow: hidden;
          transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
          max-height: 1000px;
          opacity: 1;

          &.collapsed {
            max-height: 0;
            opacity: 0;
          }
        }

        .shogun-price-test-preview-sidebar-product-collection-child-item {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 0.8rem;
          padding: 0.25rem 0;
          justify-content: space-between;
        }

        .shogun-price-test-preview-sidebar-product-collection-child-arrow {
          color: #6b7280;
          font-size: 0.875rem;
          width: 1rem;
          text-align: center;
        }

        .shogun-price-test-preview-sidebar-product-collection-child-pricing {
          font-size: 0.875rem;
          font-weight: 500;
          color: #374151;
          display: flex;
          flex-direction: column;
          line-height: normal;
        }
         
        .shogun-price-test-preview-sidebar-product-collection-child-pricing-row {
          display: flex;
          flex-direction: row;
          gap: 0.5rem;
        }

        .shogun-price-test-preview-sidebar-product-collection-child-main-content {
          display: flex;
          justify-content: flex-start;
          gap: 0.5rem;
          align-items: center;
        }
      </style>
      <div class="shogun-price-test-preview-sidebar">
        <div class="shogun-price-test-preview-sidebar-header">
          <div class="shogun-price-test-preview-sidebar-title">
            Check the updated theme for errors 
          </div>
          <div class="shogun-price-test-preview-sidebar-description">
            <span>We have created a variant theme with your chosen price changes. Please check everywhere your prices may appear such as product pages, collection pages, and featured product elements.</span>
            <br>
            <span>When you're done reviewing close this tab and return to Shogun.</span>
            <br>
            <span>If something is wrong please let us know.</span>
            <br>
            <button class="shogun-price-test-preview-sidebar-contact-support-button" onclick="contactSupport()">Contact support</button>
          </div>
        </div>

        <div class="shogun-price-test-preview-sidebar-content">
          <div class="shogun-price-test-preview-sidebar-currency-info">
            Prices shown in {{ cart.currency.iso_code }}
          </div>
          <div class="shogun-price-test-preview-sidebar-product-collection-container">
            {% for collection_config in optimization_config.collections -%}
              {%- assign collection = collections[collection_config.handle] -%}
              {% if collection != nil %}
                <div class="shogun-price-test-preview-sidebar-product-collection-item-container">
                  <div class="shogun-price-test-preview-sidebar-product-collection-header">
                    <div class="shogun-price-test-preview-sidebar-product-collection-header-child">
                      <div class="shogun-price-test-preview-sidebar-image-container">
                        <img src="{{ collection.featured_image | image_url: width: image_size }}" width="{{ image_size }}" height="{{ image_size }}"/>
                      </div>
                      <div class="shogun-price-test-preview-sidebar-title-container">
                        <span>{{ collection.title }}</span>
                      </div>
                      <button class="shogun-price-test-preview-sidebar-product-collection-caret" onclick="toggleCollection('collection-{{ forloop.index }}')">
                        {{ caret_symbol }}
                      </button>
                      <div class="shogun-price-test-preview-sidebar-collection-badge">
                        Collection
                      </div>
                    </div>
                    <div class="shogun-price-test-preview-sidebar-product-collection-header-child">
                      <div class="shogun-price-test-preview-sidebar-count-badge">
                        {{ collection_config.product_ids.size }}
                      </div>
                    </div>
                  </div>
                  <div class="shogun-price-test-preview-sidebar-product-collection-children" id="collection-{{ forloop.index }}">
                    {% for product in collection.products %}
                      {% for product_config in optimization_config.products %}
                        {% if product.title != blank and product.id == product_config.id and product.variants.size > 0 %}
                          <div class="shogun-price-test-preview-sidebar-product-collection-child-item">
                            <div class="shogun-price-test-preview-sidebar-product-collection-child-main-content">
                              <div class="shogun-price-test-preview-sidebar-product-collection-child-arrow">
                                {{ arrow_symbol }}
                              </div>
                              <div class="shogun-price-test-preview-sidebar-image-container">
                                <img src="{{ product.featured_image | image_url: width: image_size }}" width="{{ image_size }}" height="{{ image_size }}"/>
                              </div>
                              <div class="shogun-price-test-preview-sidebar-title-container">
                                <span>{{ product.title }}</span>
                              </div>
                              {% if product.variants.size > 1 %}
                              <button class="shogun-price-test-preview-sidebar-product-collection-caret" onclick="toggleProduct('collection-{{ forloop.parentloop.index }}-product-{{ forloop.index }}')">
                                {{ caret_symbol }}
                              </button>
                              {% endif %}
                            </div>
                            {% if product.variants.size > 1 %}
                              <div class="shogun-price-test-preview-sidebar-count-badge">
                                {{ product_config.variant_pricing.size }}
                              </div>
                            {% endif %}
                            {% if product.variants.size == 1 %}
                              <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing">
                                {%- assign original_price = product_config.variant_pricing.first.original_price -%}
                                {%- assign new_price = product_config.variant_pricing.first.test_price -%}
                                {%- assign price_change = product_config.variant_pricing.first.price_change -%}
                                {%- assign original_compare_at_price = product_config.variant_pricing.first.original_compare_at_price -%}
                                {%- assign test_compare_at_price = product_config.variant_pricing.first.test_compare_at_price -%}

                                {%- comment -%} Convert prices to presentment currency {%- endcomment -%}
                                {%- assign variant = product.variants.first -%}
                                {%- assign ab_presentment_baseline_cents = variant.price -%}
                                {%- assign ab_original_shop_cents = original_price | plus: 0 -%}
                                {%- assign ab_price_shop_cents = new_price | plus: 0 -%}
                                {%- assign ab_compare_at_shop_cents = test_compare_at_price | plus: 0 -%}

                                {%- assign ab_price_cents = nil -%}
                                {%- if ab_price_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                                  {%- assign ab_price_cents = ab_price_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                                {%- endif -%}

                                {%- assign ab_compare_at_cents = nil -%}
                                {%- if test_compare_at_price != blank and ab_compare_at_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                                  {%- assign ab_compare_at_cents = ab_compare_at_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                                {%- endif -%}

                                {%- assign converted_original = ab_presentment_baseline_cents -%}
                                {%- assign converted_new = ab_price_cents | default: ab_price_shop_cents -%}
                                {%- if test_compare_at_price != blank and ab_compare_at_cents -%}
                                  {%- assign converted_test_compare_at = ab_compare_at_cents -%}
                                {%- endif -%}

                                <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                                <div>{{ converted_original | money }}</div>
                                <div>&#8594;</div>
                                <div>{{ converted_new | money }}</div>
                                </div>
                                {%- if converted_test_compare_at != blank -%}
                                <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                                  <div>Compare at: {{ converted_test_compare_at | money }}</div>
                                </div>
                                {%- endif -%}
                              </div>
                            {% endif %}
                            {%- assign converted_test_compare_at = null -%}
                          </div>
                          {% if product.variants.size > 1 %}
                            <div class="shogun-price-test-preview-sidebar-product-collection-children" id="collection-{{ forloop.parentloop.index }}-product-{{ forloop.index }}">
                              {% for variant in product.variants %}
                                {% for variant_pricing in product_config.variant_pricing %}
                                  {% if variant_pricing.id == variant.id %}
                                    <div class="shogun-price-test-preview-sidebar-product-collection-child-item">
                                      <div class="shogun-price-test-preview-sidebar-product-collection-child-arrow">
                                        {{ arrow_symbol }}
                                      </div>
                                      <div class="shogun-price-test-preview-sidebar-image-container">
                                        <img src="{{ variant.featured_image | default: product.featured_image | image_url: width: image_size }}" width="{{ image_size }}" height="{{ image_size }}"/>
                                      </div>
                                      <div class="shogun-price-test-preview-sidebar-title-container">
                                        <span>{{ variant.title | default: product.title }}</span>
                                      </div>
                                      <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing">
                                        {%- assign original_price = variant_pricing.original_price -%}
                                        {%- assign new_price = variant_pricing.test_price -%}
                                        {%- assign price_change = variant_pricing.price_change -%}
                                        {%- assign original_compare_at_price = variant_pricing.original_compare_at_price -%}
                                        {%- assign test_compare_at_price = variant_pricing.test_compare_at_price -%}

                                        {%- assign ab_presentment_baseline_cents = variant.price -%}
                                        {%- assign ab_original_shop_cents = original_price | plus: 0 -%}
                                        {%- assign ab_price_shop_cents = new_price | plus: 0 -%}
                                        {%- assign ab_compare_at_shop_cents = test_compare_at_price | plus: 0 -%}

                                        {%- assign ab_price_cents = nil -%}
                                        {%- if ab_price_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                                          {%- assign ab_price_cents = ab_price_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                                        {%- endif -%}

                                        {%- assign ab_compare_at_cents = nil -%}
                                        {%- if test_compare_at_price != blank and ab_compare_at_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                                          {%- assign ab_compare_at_cents = ab_compare_at_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                                        {%- endif -%}

                                        {%- assign converted_original = ab_presentment_baseline_cents -%}
                                        {%- assign converted_new = ab_price_cents | default: ab_price_shop_cents -%}
                                        {%- if test_compare_at_price != blank and ab_compare_at_cents -%}
                                          {%- assign converted_test_compare_at = ab_compare_at_cents -%}
                                        {%- endif -%}

                                        <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                                          <div>{{ converted_original | money }}</div>
                                          <div>&#8594;</div>
                                          <div>{{ converted_new | money }}</div>
                                        </div>
                                        
                                        {%- if converted_test_compare_at != blank -%}
                                        <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                                          <div>Compare at: {{ converted_test_compare_at | money }}</div>
                                        </div>
                                        {%- endif -%}
                                      </div>
                                    </div>
                                  {% endif %}
                                  {%- assign converted_test_compare_at = null -%}
                                {% endfor %}
                              {% endfor %}
                            </div>
                          {% endif %}
                        {% endif %}
                      {%  endfor %}
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endfor -%}
            {%- assign products_in_collections = '' -%}
            {% for collection_config in optimization_config.collections -%}
              {%- assign collection = collections[collection_config.handle] -%}
              {% if collection != nil %}
                {% for product in collection.products %}
                  {%- assign products_in_collections = products_in_collections | append: product.handle | append: ',' -%}
                {% endfor %}
              {% endif %}
            {% endfor -%}
            {% for product_config in optimization_config.products -%}
              {%- assign product = all_products[product_config.handle] -%}
              {%- assign product_in_collection = false -%}
              {%- if products_in_collections contains product_config.handle -%}
                {%- assign product_in_collection = true -%}
              {%- endif -%}
              {% if product != nil and product_in_collection == false and product.title != blank and product.variants.size > 0 %}
                <div class="shogun-price-test-preview-sidebar-product-collection-item-container">
                  <div class="shogun-price-test-preview-sidebar-product-collection-header">
                    <div class="shogun-price-test-preview-sidebar-product-collection-header-child">
                      <div class="shogun-price-test-preview-sidebar-image-container">
                        <img src="{{ product.featured_image | image_url: width: image_size }}" width="{{ image_size }}" height="{{ image_size }}"/>
                      </div>
                      <div class="shogun-price-test-preview-sidebar-title-container">
                        <span>{{ product.title }}</span>
                      </div>
                      {% if product.variants.size > 1 %}
                        <button class="shogun-price-test-preview-sidebar-product-collection-caret" onclick="toggleProduct('product-{{ forloop.index }}')">
                          {{ caret_symbol }}
                        </button>
                      {% endif %}
                    </div>
                    <div class="shogun-price-test-preview-sidebar-product-collection-header-child">
                      {% if product.variants.size > 1 %}
                        <div class="shogun-price-test-preview-sidebar-count-badge">
                          {{ product_config.variant_pricing.size }}
                        </div>
                      {% endif %}
                      {% if product.variants.size == 1 %}
                        <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing">
                          {%- assign original_price = product_config.variant_pricing.first.original_price -%}
                          {%- assign new_price = product_config.variant_pricing.first.test_price -%}
                          {%- assign price_change = product_config.variant_pricing.first.price_change -%}
                          {%- assign original_compare_at_price = product_config.variant_pricing.first.original_compare_at_price -%}
                          {%- assign test_compare_at_price = product_config.variant_pricing.first.test_compare_at_price -%}

                          {%- comment -%} Convert prices to presentment currency {%- endcomment -%}
                          {%- assign variant = product.variants.first -%}
                          {%- assign ab_presentment_baseline_cents = variant.price -%}
                          {%- assign ab_original_shop_cents = original_price | plus: 0 -%}
                          {%- assign ab_price_shop_cents = new_price | plus: 0 -%}
                          {%- assign ab_compare_at_shop_cents = test_compare_at_price | plus: 0 -%}

                          {%- assign ab_price_cents = nil -%}
                          {%- if ab_price_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                            {%- assign ab_price_cents = ab_price_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                          {%- endif -%}

                          {%- assign ab_compare_at_cents = nil -%}
                          {%- if test_compare_at_price != blank and ab_compare_at_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                            {%- assign ab_compare_at_cents = ab_compare_at_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                          {%- endif -%}

                          {%- assign converted_original = ab_presentment_baseline_cents -%}
                          {%- assign converted_new = ab_price_cents | default: ab_price_shop_cents -%}
                          {%- if test_compare_at_price != blank and ab_compare_at_cents -%}
                            {%- assign converted_test_compare_at = ab_compare_at_cents -%}
                          {%- endif -%}

                          <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                            <div>{{ converted_original | money }}</div>
                            <div>&#8594;</div>
                            <div>{{ converted_new | money }}</div>
                          </div>
                          {%- if converted_test_compare_at != blank -%}
                            <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                              <div>Compare at: {{ converted_test_compare_at | money }}</div>
                            </div>
                          {%- endif -%}
                        </div>
                      {% endif %}
                    </div>
                    {%- assign converted_test_compare_at = null -%}
                  </div>
                  {% if product.variants.size > 1 %}
                    <div class="shogun-price-test-preview-sidebar-product-collection-children" id="product-{{ forloop.index }}">
                      {% for variant in product.variants %}
                        {% for variant_pricing in product_config.variant_pricing %}
                          {% if variant_pricing.id == variant.id %}
                            <div class="shogun-price-test-preview-sidebar-product-collection-child-item">
                              <div class="shogun-price-test-preview-sidebar-product-collection-child-arrow">
                                {{ arrow_symbol }}
                              </div>
                              <div class="shogun-price-test-preview-sidebar-image-container">
                                <img src="{{ variant.featured_image | default: product.featured_image | image_url: width: image_size }}" width="{{ image_size }}" height="{{ image_size }}"/>
                              </div>
                              <div class="shogun-price-test-preview-sidebar-title-container">
                                <span>{{ variant.title | default: product.title }}</span>
                              </div>
                              <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing">
                                {%- assign original_price = variant_pricing.original_price -%}
                                {%- assign new_price = variant_pricing.test_price -%}
                                {%- assign price_change = variant_pricing.price_change -%}
                                {%- assign original_compare_at_price = variant_pricing.original_compare_at_price -%}
                                {%- assign test_compare_at_price = variant_pricing.test_compare_at_price -%}

                                {%- assign ab_presentment_baseline_cents = variant.price -%}
                                {%- assign ab_original_shop_cents = original_price | plus: 0 -%}
                                {%- assign ab_price_shop_cents = new_price | plus: 0 -%}
                                {%- assign ab_compare_at_shop_cents = test_compare_at_price | plus: 0 -%}

                                {%- assign ab_price_cents = nil -%}
                                {%- if ab_price_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                                  {%- assign ab_price_cents = ab_price_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                                {%- endif -%}

                                {%- assign ab_compare_at_cents = nil -%}
                                {%- if test_compare_at_price != blank and ab_compare_at_shop_cents and ab_original_shop_cents and ab_original_shop_cents > 0 -%}
                                  {%- assign ab_compare_at_cents = ab_compare_at_shop_cents | times: ab_presentment_baseline_cents | divided_by: ab_original_shop_cents | round -%}
                                {%- endif -%}

                                {%- assign converted_original = ab_presentment_baseline_cents -%}
                                {%- assign converted_new = ab_price_cents | default: ab_price_shop_cents -%}
                                {%- if test_compare_at_price != blank and ab_compare_at_cents -%}
                                  {%- assign converted_test_compare_at = ab_compare_at_cents -%}
                                {%- endif -%}

                                <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                                  <div>{{ converted_original | money }}</div>
                                  <div>&#8594;</div>
                                  <div>{{ converted_new | money }}</div>
                                </div>
                                {%- if converted_test_compare_at != blank -%}                              
                                  <div class="shogun-price-test-preview-sidebar-product-collection-child-pricing-row">
                                    <div>Compare at: {{ converted_test_compare_at | money }}</div>
                                  </div>
                                {%- endif -%}
                              </div>
                            </div>
                          {% endif %}
                          {%- assign converted_test_compare_at = null -%}
                        {% endfor %}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div> 
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </template>
    <script>
      const COLLAPSED_STATE_KEY = 'shogun_price_test_sidebar_collapsed_state';

      function saveCollapsedState(elementId, isCollapsed) {
        try {
          const state = JSON.parse(localStorage.getItem(COLLAPSED_STATE_KEY) || '{}');
          state[elementId] = isCollapsed;
          localStorage.setItem(COLLAPSED_STATE_KEY, JSON.stringify(state));
        } catch (e) {
          console.warn('Failed to save collapsed state:', e);
        }
      }

      function restoreCollapsedState() {
        try {
          const state = JSON.parse(localStorage.getItem(COLLAPSED_STATE_KEY) || '{}');

          Object.keys(state).forEach(elementId => {
            const element = document.getElementById(elementId);
            if (element) {
              const caret = element.previousElementSibling?.querySelector('.shogun-price-test-preview-sidebar-product-collection-caret');

              if (state[elementId]) {
                element.classList.add('collapsed');
                if (caret) {
                  caret.classList.add('collapsed');
                }
              } else {
                element.classList.remove('collapsed');
                if (caret) {
                  caret.classList.remove('collapsed');
                }
              }
            }
          });
        } catch (e) {
          console.warn('Failed to restore collapsed state:', e);
        }
      }

      function toggleElement(elementId) {
        const children = document.getElementById(elementId);
        const caret = children.previousElementSibling.querySelector('.shogun-price-test-preview-sidebar-product-collection-caret');

        if (children.classList.contains('collapsed')) {
          // Expand: remove collapsed class first, then rotate caret
          children.classList.remove('collapsed');
          caret.classList.remove('collapsed');
          saveCollapsedState(elementId, false);
        } else {
          // Collapse: add collapsed class, then rotate caret
          children.classList.add('collapsed');
          caret.classList.add('collapsed');
          saveCollapsedState(elementId, true);
        }
      }

      function toggleCollection(collectionId) {
        toggleElement(collectionId);
      }

      function toggleProduct(productId) {
        toggleElement(productId);
      }

      function contactSupport() {
        const subject = encodeURIComponent('A/B Testing Question');
        const body = encodeURIComponent('Hi Shogun Team,\n\n');
        const mailtoLink = `mailto:support-ab@getshogun.com?subject=${subject}&body=${body}`;
        window.open(mailtoLink, '_blank');
      }

      // Restore collapsed state when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure all elements are rendered
        setTimeout(restoreCollapsedState, 100);
      });
    </script>
  {% endif %}
{%- endif -%}

<script type="text/javascript">
  ;(function() {
    if (typeof ShogunOptimizer === 'undefined') {
      console.error("ShogunOptimizer is not defined. Please ensure the optimizer script is properly loaded.");
      return;
    }

    const designMode = {{ request.design_mode | default: false }};
    if (designMode) {
      console.debug("Design mode is enabled, skipping optimizer initialization");
      return;
    }

    // If the referrer url is the Shopify admin url, then set a local storage shg_is_merchant flag to true
    // This is used to remove the preview bar from the page for shoppers
    const referrer = document.referrer
    if (!localStorage.getItem('_shg_is_merchant') && ((referrer.includes('admin.shopify.com') || referrer.includes('shogun')))) {
      console.debug('Setting shg_is_merchant to true')
      localStorage.setItem('_shg_is_merchant', 'true')
    }

    const urlParams = new URLSearchParams(window.location.search);
    const optimizationDisabled = urlParams.get('shg') === "false" || window.location.hostname.includes('shopifypreview');

    if (optimizationDisabled) {
      console.debug("Optimization is disabled, skipping optimizer initialization");
      return;
    }

    const shopMetafieldConfig = {{ shop.metafields.shgabc.optimizations }} || {};
    const optimizationsData = shopMetafieldConfig.expires_at > Date.now() ? (shopMetafieldConfig.optimizations || []) : [];

    const optimizerConfig = {
      shopId: "552f89ea-9faf-4caf-b102-54346ef41303",
      optimizations: optimizationsData,
      distributionMethod: urlParams.get('shgMethod') || shopMetafieldConfig.method,
      defaultThemeId: String(shopMetafieldConfig.default_theme_id),
      currentThemeId: "179206914416",
      pageId: "{{ content.id }}",
      pageType: "{% if template.name == 'list-collections' %}list-collections{% elsif article %}article{% elsif blog %}blog{% elsif page %}page{% elsif product %}product{% elsif collection %}collection{% elsif metaobject %}metaobject{% else %}homepage{% endif %}",
      templateName: "{{ template.name }}",
      templateSuffix: "{{ template.suffix }}",
      customerId: "{{ customer.id }}",
      isB2B: {{ customer.b2b? | default: false }},
      sessionIdOverride: urlParams.get('shgSessionId'),
      geoLocationApi: "https://ipinfo.io/json?token=f2ae3a557d807b",
      currentPricingVariantId: {% if cart.attributes.shogun_variant_id %}"{{ cart.attributes.shogun_variant_id }}"{% else %}null{%  endif %},
      languageRootUrl: "{{ localization.language.root_url }}",
      analyticsUrl: "https://shogun-abc-production.global.ssl.fastly.net"
    };

    console.debug("Initializing ShogunOptimizer with config:", optimizerConfig);
    const optimizer = new ShogunOptimizer(optimizerConfig);
    optimizer.run();
  })();
</script>
